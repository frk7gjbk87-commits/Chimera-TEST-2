<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chimera AI</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #0f1720;
      --panel: #152432;
      --panel-2: #101a24;
      --line: #33556c;
      --text: #eff8ff;
      --muted: #a8c6da;
      --accent: #69c1f7;
      --accent-2: #f0ad64;
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      margin: 0;
      width: 100%;
      height: 100%;
      font-family: "Space Grotesk", "Segoe UI", sans-serif;
      background:
        radial-gradient(circle at 12% 9%, rgba(78, 164, 212, 0.22), transparent 35%),
        radial-gradient(circle at 88% 2%, rgba(242, 157, 77, 0.2), transparent 32%),
        linear-gradient(160deg, #0a1118 0%, #111f2b 55%, #1f1d1a 100%);
      color: var(--text);
    }

    .ai-shell {
      display: grid;
      grid-template-rows: auto 1fr auto;
      width: 100%;
      height: 100%;
      border: 1px solid rgba(126, 188, 220, 0.3);
      border-radius: 14px;
      overflow: hidden;
      background: rgba(9, 15, 21, 0.72);
      backdrop-filter: blur(14px);
    }

    .ai-header {
      padding: 12px 14px;
      border-bottom: 1px solid var(--line);
      background: linear-gradient(90deg, rgba(18, 33, 45, 0.94), rgba(31, 48, 61, 0.92));
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .ai-title {
      margin: 0;
      font-size: 16px;
      font-weight: 700;
      letter-spacing: 0.2px;
    }

    .ai-subtitle {
      margin: 0;
      font-size: 12px;
      color: var(--muted);
    }

    #backend-pill {
      border: 1px solid rgba(120, 182, 214, 0.35);
      border-radius: 999px;
      padding: 6px 9px;
      font-size: 11px;
      color: #d7ecf9;
      max-width: 260px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-family: "JetBrains Mono", monospace;
    }

    #ai-messages {
      padding: 14px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
      background:
        linear-gradient(transparent 30px, rgba(112, 159, 185, 0.05) 31px),
        linear-gradient(90deg, transparent 30px, rgba(112, 159, 185, 0.04) 31px),
        var(--panel-2);
      background-size: 31px 31px, 31px 31px, auto;
    }

    .message {
      max-width: 84%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid transparent;
      white-space: pre-wrap;
      word-break: break-word;
      line-height: 1.45;
      font-size: 14px;
    }

    .message.user {
      margin-left: auto;
      background: linear-gradient(150deg, #206e94, #3f93be);
      border-color: #6bc0e9;
      color: #f5fcff;
    }

    .message.assistant {
      margin-right: auto;
      background: linear-gradient(150deg, #223040, #2d4153);
      border-color: #4a6378;
      color: #e9f4fb;
    }

    .composer {
      padding: 12px;
      border-top: 1px solid var(--line);
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      background: linear-gradient(180deg, rgba(10, 18, 25, 0.95), rgba(13, 22, 30, 0.9));
    }

    #ai-input {
      min-height: 56px;
      resize: none;
      border: 1px solid #4a6b81;
      border-radius: 12px;
      background: rgba(10, 18, 25, 0.9);
      color: var(--text);
      padding: 10px;
      font-family: inherit;
      font-size: 14px;
    }

    #ai-send {
      width: 100px;
      border: 1px solid #73bbdf;
      border-radius: 12px;
      background: linear-gradient(140deg, var(--accent), var(--accent-2));
      color: #052033;
      font-weight: 700;
      cursor: pointer;
    }

    #ai-send:disabled,
    #ai-input:disabled {
      opacity: 0.65;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <main class="ai-shell">
    <header class="ai-header">
      <div>
        <h1 class="ai-title">Chimera AI</h1>
        <p class="ai-subtitle">Private assistant for your desktop workflow</p>
      </div>
      <div id="backend-pill"></div>
    </header>

    <section id="ai-messages" aria-live="polite"></section>

    <form id="ai-form" class="composer">
      <textarea id="ai-input" placeholder="Ask anything..." required></textarea>
      <button id="ai-send" type="submit">Send</button>
    </form>
  </main>

  <script type="module">
    const MAX_HISTORY = 12;
    const state = { history: [] };

    const backendBaseUrl =
      window.CHIMERA_BACKEND_URL ||
      localStorage.getItem("chimeraBackendUrl") ||
      (window.location.hostname.includes("github.io")
        ? "https://chimera-test-2.onrender.com"
        : "http://localhost:4000");

    const backendPill = document.getElementById("backend-pill");
    const form = document.getElementById("ai-form");
    const input = document.getElementById("ai-input");
    const sendBtn = document.getElementById("ai-send");
    const messages = document.getElementById("ai-messages");

    backendPill.textContent = backendBaseUrl;

    function appendMessage(role, text) {
      const el = document.createElement("div");
      el.className = `message ${role}`;
      el.textContent = text;
      messages.appendChild(el);
      messages.scrollTop = messages.scrollHeight;
    }

    function setBusy(isBusy) {
      input.disabled = isBusy;
      sendBtn.disabled = isBusy;
      sendBtn.textContent = isBusy ? "..." : "Send";
    }

    async function chat(message) {
      const response = await fetch(`${backendBaseUrl}/ai/chat`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          message,
          history: state.history
        })
      });

      if (!response.ok) {
        let reason = "AI service unavailable.";
        try {
          const payload = await response.json();
          reason = payload.error || reason;
        } catch {
          // Keep fallback reason.
        }
        throw new Error(reason);
      }

      const data = await response.json();
      return data.reply || "No response returned.";
    }

    form.addEventListener("submit", async (event) => {
      event.preventDefault();
      const text = input.value.trim();
      if (!text) return;

      input.value = "";
      appendMessage("user", text);
      state.history.push({ role: "user", text });
      state.history = state.history.slice(-MAX_HISTORY);

      setBusy(true);
      try {
        const reply = await chat(text);
        appendMessage("assistant", reply);
        state.history.push({ role: "assistant", text: reply });
        state.history = state.history.slice(-MAX_HISTORY);
      } catch (error) {
        appendMessage("assistant", String(error.message || "Could not reach AI service."));
      } finally {
        setBusy(false);
      }
    });

    appendMessage("assistant", "Chimera AI ready.");
  </script>
</body>
</html>
